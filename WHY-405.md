# Tại sao lỗi 405 Not Allowed?

## Nguyên nhân chính:

Lỗi **405 Not Allowed** xảy ra khi server **từ chối method POST**. Có thể do:

### 1. **Server không hỗ trợ .htaccess**
- File `.htaccess` không được load
- Server không cho phép override configuration qua `.htaccess`
- Cần cấu hình trực tiếp trong `httpd.conf` hoặc `apache2.conf`

### 2. **Server đang block POST requests**
- Firewall hoặc security module đang block POST
- ModSecurity hoặc các security rules đang chặn
- Server chỉ cho phép GET requests

### 3. **.htaccess có syntax error**
- File `.htaccess` có lỗi syntax
- Server không thể parse file
- Apache/Nginx bỏ qua file `.htaccess`

### 4. **Thiếu modules cần thiết**
- Thiếu `mod_rewrite` (cho RewriteRule)
- Thiếu `mod_headers` (cho Header directive)
- Thiếu `mod_limit` (cho Limit directive)

## Cách kiểm tra:

### Bước 1: Test POST method
Truy cập trong browser:
```
https://yourdomain.com/api/test-post.php
```

Sau đó mở **Console** (F12) và chạy:
```javascript
fetch('https://yourdomain.com/api/test-post.php', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({test: 'data'})
})
.then(r => r.json())
.then(d => console.log('POST works:', d))
.catch(e => console.error('POST failed:', e));
```

**Nếu vẫn 405** → Server đang block POST method

### Bước 2: Kiểm tra .htaccess có được load không

Tạo file `api/check-htaccess.php`:
```php
<?php
header('Content-Type: application/json');
echo json_encode([
    'htaccess_exists' => file_exists('.htaccess'),
    'htaccess_readable' => is_readable('.htaccess'),
    'apache_modules' => function_exists('apache_get_modules') ? apache_get_modules() : 'Not available'
]);
?>
```

### Bước 3: Kiểm tra Apache modules

Tạo file `api/check-modules.php`:
```php
<?php
header('Content-Type: application/json');
$modules = [];
if (function_exists('apache_get_modules')) {
    $modules = apache_get_modules();
}
echo json_encode([
    'mod_rewrite' => in_array('mod_rewrite', $modules),
    'mod_headers' => in_array('mod_headers', $modules),
    'all_modules' => $modules
]);
?>
```

## Giải pháp:

### Giải pháp 1: Sử dụng .htaccess đơn giản

Thay thế nội dung `api/.htaccess` bằng:
```apache
# Minimal .htaccess
AddHandler application/x-httpd-php .php
Options -Indexes
```

Không dùng `Limit` hoặc `RewriteRule` - chỉ để PHP chạy.

### Giải pháp 2: Không dùng .htaccess

Xóa file `.htaccess` và cấu hình trực tiếp trong server config:

**Apache (`httpd.conf` hoặc `apache2.conf`):**
```apache
<Directory "/path/to/api">
    AllowOverride None
    Options -Indexes
    <FilesMatch "\.php$">
        SetHandler application/x-httpd-php
    </FilesMatch>
</Directory>
```

**Nginx (`nginx.conf`):**
```nginx
location /api/ {
    try_files $uri =404;
    fastcgi_pass unix:/var/run/php/php7.4-fpm.sock;
    fastcgi_index index.php;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
    include fastcgi_params;
}
```

### Giải pháp 3: Kiểm tra với hosting

Nếu dùng shared hosting (cPanel, etc.):
1. Vào **cPanel** → **File Manager**
2. Tìm file `.htaccess` trong thư mục `api`
3. Kiểm tra có lỗi syntax không
4. Thử xóa file `.htaccess` và test xem POST có hoạt động không
5. Nếu POST hoạt động sau khi xóa → Vấn đề là ở `.htaccess`

### Giải pháp 4: Liên hệ hosting

Hỏi hosting:
1. Server có hỗ trợ `.htaccess` không?
2. Có modules nào đang block POST requests không?
3. Có thể cấu hình để cho phép POST trong thư mục `api/` không?
4. Có ModSecurity hoặc firewall đang chặn POST không?

## Test nhanh:

1. **Xóa file `.htaccess`** trong thư mục `api/`
2. **Test lại** đăng ký
3. **Nếu POST hoạt động** → Vấn đề là ở `.htaccess`
4. **Nếu vẫn 405** → Server đang block POST ở cấp cao hơn

## Kết luận:

Lỗi 405 thường do:
- **Server không cho phép POST** (phổ biến nhất)
- **.htaccess không được load** hoặc có lỗi
- **Thiếu modules** cần thiết

Cách fix nhanh nhất: **Xóa `.htaccess`** và test xem POST có hoạt động không. Nếu có → Sửa lại `.htaccess` đơn giản hơn. Nếu không → Liên hệ hosting.
